// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id              String   @id @default(uuid())
  email           String   @unique
  nombre          String
  imagenPublicId  String?
  imagenUrl       String?
  imagenSecureUrl String?
  password        String
  rol             String   @default("cliente")
  creado          DateTime @default(now())
  status          String   @default("activo") // "activo" | "inactivo" | "suspendido"

  entrenador             Entrenador?
  asignacionesEntrenador AsignacionEntrenador[] @relation("ClienteEntrenador")
  reservas               Reserva[]
  suscripciones          Suscripcion[]
  asistencias            Asistencia[]
  carritoItems           CarritoItem[]
  ordenes                Orden[]

  @@map("usuarios")
}

model Producto {
  id              String   @id @default(uuid())
  nombre          String
  descripcion     String?
  imagenPublicId  String?
  imagenUrl       String?
  imagenSecureUrl String?
  precio          Float
  stock           Int      @default(0)
  categoria       String
  creado          DateTime @default(now())

  carritoItems CarritoItem[]
  ordenItems   OrdenItem[]

  @@map("productos")
}

model Entrenador {
  id              String                 @id @default(uuid())
  usuarioId       String                 @unique
  usuario         Usuario                @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  especialidad    String
  experiencia     Int                    @default(0)
  certificaciones String?
  clientes        AsignacionEntrenador[]
  creado          DateTime               @default(now())
  clases          Clase[]

  @@map("entrenadores")
}

model AsignacionEntrenador {
  id              String     @id @default(uuid())
  clienteId       String
  cliente         Usuario    @relation("ClienteEntrenador", fields: [clienteId], references: [id], onDelete: Cascade)
  entrenadorId    String
  entrenador      Entrenador @relation(fields: [entrenadorId], references: [id], onDelete: Cascade)
  fechaAsignacion DateTime   @default(now())
  activo          Boolean    @default(true)

  @@unique([clienteId, entrenadorId])
  @@map("asignaciones_entrenador")
}

model Clase {
  id           String     @id @default(uuid())
  nombre       String
  descripcion  String?
  duracion     Int        @default(60)
  capacidad    Int
  entrenadorId String
  entrenador   Entrenador @relation(fields: [entrenadorId], references: [id], onDelete: Cascade)
  sesiones     Sesion[]
  creado       DateTime   @default(now())

  @@map("clases")
}

model Sesion {
  id        String    @id @default(uuid())
  claseId   String
  clase     Clase     @relation(fields: [claseId], references: [id], onDelete: Cascade)
  fechaHora DateTime
  reservas  Reserva[]
  creado    DateTime  @default(now())

  asistencias Asistencia[]

  @@map("sesiones")
}

model Reserva {
  id        String   @id @default(uuid())
  clienteId String
  cliente   Usuario  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  sesionId  String
  sesion    Sesion   @relation(fields: [sesionId], references: [id], onDelete: Cascade)
  estado    String   @default("reservado")
  creado    DateTime @default(now())

  @@unique([clienteId, sesionId])
  @@map("reservas")
}

model Plan {
  id           String   @id @default(uuid())
  nombre       String
  descripcion  String?
  precio       Float
  duracionDias Int
  beneficios   String?
  nivel        Int?
  creado       DateTime @default(now())
  actualizada  DateTime @updatedAt

  suscripciones Suscripcion[]

  @@map("planes")
}

model Suscripcion {
  id               String            @id @default(uuid())
  usuarioId        String
  planId           String
  estado           EstadoSuscripcion @default(ACTIVA)
  fechaInicio      DateTime          @default(now())
  fechaVencimiento DateTime
  creado           DateTime          @default(now())
  actualizada      DateTime          @updatedAt
  monto            Float

  usuario Usuario @relation(fields: [usuarioId], references: [id])
  plan    Plan    @relation(fields: [planId], references: [id])
  
  @@map("suscripciones")
}

enum EstadoSuscripcion {
  ACTIVA
  CANCELADA
  VENCIDA
}

model Asistencia {
  id          String    @id @default(uuid())
  sesionId    String
  sesion      Sesion    @relation(fields: [sesionId], references: [id], onDelete: Cascade)
  clienteId   String
  cliente     Usuario   @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  estado      String    @default("asistio")
  horaEntrada DateTime?
  creado      DateTime  @default(now())

  @@unique([sesionId, clienteId])
  @@map("asistencias")
}

model CarritoItem {
  id         String   @id @default(uuid())
  usuarioId  String
  usuario    Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  productoId String
  producto   Producto @relation(fields: [productoId], references: [id], onDelete: Cascade)
  cantidad   Int      @default(1)
  creado     DateTime @default(now())

  @@unique([usuarioId, productoId])
  @@map("carrito_items")
}

model Orden {
  id        String      @id @default(uuid())
  usuarioId String
  usuario   Usuario     @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  items     OrdenItem[]
  total     Float
  estado    EstadoOrden @default(PENDIENTE)
  creado    DateTime    @default(now())

  @@map("ordenes")
}

enum EstadoOrden {
  PENDIENTE
  PAGADA
  ENVIADA
  CANCELADA
  COMPLETADA
}

model OrdenItem {
  id             String   @id @default(uuid())
  ordenId        String
  orden          Orden    @relation(fields: [ordenId], references: [id], onDelete: Cascade)
  productoId     String
  producto       Producto @relation(fields: [productoId], references: [id])
  cantidad       Int
  precioUnitario Float
  subtotal       Float

  @@map("orden_items")
}

model Configuracion {
  id                    String   @id @default(uuid())
  nombreGimnasio        String
  direccion             String
  telefono              String
  emailContacto         String
  moneda                String
  impuestos             Float
  horarioApertura       String
  horarioCierre         String
  permitirReservas      Boolean
  duracionSesionMinutos Int
  maxClasesPorDia       Int
  permitirPagoOnline    Boolean
  metodosPago           String[]
  notificarEmail        Boolean
  emailNotificaciones   String?
  notificarWhatsapp     Boolean
  whatsappNumero        String?
  logoUrl               String?
  colorPrincipal        String
  colorSecundario       String
  creado                DateTime @default(now())
  actualizado           DateTime @updatedAt
}
